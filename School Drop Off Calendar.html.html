import React, { useState, useEffect } from ‚Äòreact‚Äô;
import { Calendar, Users, Bell, Share2, AlertCircle, X } from ‚Äòlucide-react‚Äô;

// NSW School Holidays 2026 (Term dates)
const NSW_HOLIDAYS_2026 = [
{ start: ‚Äò2026-01-01‚Äô, end: ‚Äò2026-01-29‚Äô, name: ‚ÄòSummer Holidays‚Äô },
{ start: ‚Äò2026-04-06‚Äô, end: ‚Äò2026-04-17‚Äô, name: ‚ÄòAutumn Holidays‚Äô },
{ start: ‚Äò2026-06-29‚Äô, end: ‚Äò2026-07-10‚Äô, name: ‚ÄòWinter Holidays‚Äô },
{ start: ‚Äò2026-09-21‚Äô, end: ‚Äò2026-10-02‚Äô, name: ‚ÄòSpring Holidays‚Äô },
{ start: ‚Äò2026-12-18‚Äô, end: ‚Äò2027-01-28‚Äô, name: ‚ÄòSummer Holidays‚Äô }
];

const SchoolPickupApp = () => {
const [currentDate, setCurrentDate] = useState(new Date());
const [schedule, setSchedule] = useState({});
const [people, setPeople] = useState({});
const [showAddModal, setShowAddModal] = useState(false);
const [showSettingsModal, setShowSettingsModal] = useState(false);
const [selectedDate, setSelectedDate] = useState(null);
const [selectedType, setSelectedType] = useState(‚Äòpickup‚Äô);
const [personName, setPersonName] = useState(‚Äô‚Äô);
const [notificationPreference, setNotificationPreference] = useState(‚Äòpush‚Äô);
const [phoneNumber, setPhoneNumber] = useState(‚Äô‚Äô);
const [shareUrl, setShareUrl] = useState(‚Äô‚Äô);

const PERSON_COLORS = [
‚Äò#8B5CF6‚Äô, // Purple
‚Äò#EC4899‚Äô, // Pink
‚Äò#F59E0B‚Äô, // Amber
‚Äò#10B981‚Äô, // Emerald
‚Äò#3B82F6‚Äô, // Blue
‚Äò#EF4444‚Äô, // Red
‚Äò#14B8A6‚Äô, // Teal
‚Äò#F97316‚Äô, // Orange
];

// Load schedule from storage
useEffect(() => {
loadSchedule();
loadPeople();
loadNotificationPreference();
checkNotifications();
}, []);

const loadSchedule = async () => {
try {
const result = await window.storage.get(‚Äòschool-pickup-schedule‚Äô, true);
if (result && result.value) {
setSchedule(JSON.parse(result.value));
}
} catch (error) {
console.log(‚ÄòNo existing schedule found‚Äô);
}
};

const loadPeople = async () => {
try {
const result = await window.storage.get(‚Äòschool-pickup-people‚Äô, true);
if (result && result.value) {
setPeople(JSON.parse(result.value));
}
} catch (error) {
console.log(‚ÄòNo existing people found‚Äô);
}
};

const loadNotificationPreference = async () => {
try {
const result = await window.storage.get(‚Äònotification-preference‚Äô);
if (result && result.value) {
const data = JSON.parse(result.value);
setNotificationPreference(data.preference || ‚Äòpush‚Äô);
setPhoneNumber(data.phoneNumber || ‚Äò‚Äô);
}
} catch (error) {
console.log(‚ÄòNo notification preference found‚Äô);
}
};

const saveNotificationPreference = async (preference, phone) => {
try {
await window.storage.set(‚Äònotification-preference‚Äô, JSON.stringify({
preference,
phoneNumber: phone
}));
setNotificationPreference(preference);
setPhoneNumber(phone);
} catch (error) {
console.error(‚ÄòFailed to save notification preference:‚Äô, error);
}
};

const saveSchedule = async (newSchedule) => {
try {
await window.storage.set(‚Äòschool-pickup-schedule‚Äô, JSON.stringify(newSchedule), true);
setSchedule(newSchedule);
} catch (error) {
console.error(‚ÄòFailed to save schedule:‚Äô, error);
}
};

const savePeople = async (newPeople) => {
try {
await window.storage.set(‚Äòschool-pickup-people‚Äô, JSON.stringify(newPeople), true);
setPeople(newPeople);
} catch (error) {
console.error(‚ÄòFailed to save people:‚Äô, error);
}
};

const getOrAssignColor = (name) => {
if (people[name]) {
return people[name].color;
}

```
// Assign new color
const usedColors = Object.values(people).map(p => p.color);
const availableColor = PERSON_COLORS.find(c => !usedColors.includes(c)) || PERSON_COLORS[0];

const newPeople = {
  ...people,
  [name]: { color: availableColor }
};
savePeople(newPeople);
return availableColor;
```

};

const checkNotifications = () => {
setInterval(() => {
const now = new Date();
const todayKey = formatDate(now);
const todaySchedule = schedule[todayKey];

```
  if (!todaySchedule) return;

  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();
  
  // Check pickup notification (1 hour before - e.g., 2 PM for 3 PM pickup)
  if (currentHour === 14 && currentMinute === 0 && todaySchedule.pickup) {
    sendNotification(`Reminder: ${todaySchedule.pickup} has school pickup today at 3 PM`);
  }
  
  // Check dropoff notification (1 hour before - e.g., 7 AM for 8 AM dropoff)
  if (currentHour === 7 && currentMinute === 0 && todaySchedule.dropoff) {
    sendNotification(`Reminder: ${todaySchedule.dropoff} has school dropoff today at 8 AM`);
  }
}, 60000);
```

};

const sendNotification = (message) => {
if (notificationPreference === ‚Äòpush‚Äô || notificationPreference === ‚Äòboth‚Äô) {
if (‚ÄòNotification‚Äô in window && Notification.permission === ‚Äògranted‚Äô) {
new Notification(‚ÄòSchool Pickup/Dropoff Reminder‚Äô, {
body: message,
icon: ‚Äòüìö‚Äô
});
} else {
alert(message);
}
}

```
if (notificationPreference === 'sms' || notificationPreference === 'both') {
  // In a real app, this would call an SMS API
  console.log(`Would send SMS to ${phoneNumber}: ${message}`);
  // For demo purposes, show an alert
  alert(`SMS would be sent to ${phoneNumber}: ${message}`);
}
```

};

const formatDate = (date) => {
return date.toISOString().split(‚ÄòT‚Äô)[0];
};

const isWeekday = (date) => {
const day = date.getDay();
return day !== 0 && day !== 6; // Not Sunday or Saturday
};

const isHoliday = (date) => {
const dateStr = formatDate(date);
return NSW_HOLIDAYS_2026.some(holiday =>
dateStr >= holiday.start && dateStr <= holiday.end
);
};

const getHolidayName = (date) => {
const dateStr = formatDate(date);
const holiday = NSW_HOLIDAYS_2026.find(h =>
dateStr >= h.start && dateStr <= h.end
);
return holiday ? holiday.name : null;
};

const getDaysInMonth = (date) => {
const year = date.getFullYear();
const month = date.getMonth();
const firstDay = new Date(year, month, 1);
const lastDay = new Date(year, month + 1, 0);
const daysInMonth = lastDay.getDate();
const startingDayOfWeek = firstDay.getDay();

```
const days = [];

// Add empty cells for days before the month starts
for (let i = 0; i < startingDayOfWeek; i++) {
  days.push(null);
}

// Add all days in the month
for (let day = 1; day <= daysInMonth; day++) {
  days.push(new Date(year, month, day));
}

return days;
```

};

const handleDateClick = (date) => {
if (!date || !isWeekday(date) || isHoliday(date)) return;
setSelectedDate(date);
setShowAddModal(true);
};

const handleAddPerson = () => {
if (!personName.trim() || !selectedDate) return;

```
const dateKey = formatDate(selectedDate);
const newSchedule = { ...schedule };

if (!newSchedule[dateKey]) {
  newSchedule[dateKey] = {};
}

newSchedule[dateKey][selectedType] = personName.trim();

// Assign color if new person
getOrAssignColor(personName.trim());

saveSchedule(newSchedule);

setPersonName('');
setShowAddModal(false);
```

};

const handleRemovePerson = (date, type) => {
const dateKey = formatDate(date);
const newSchedule = { ‚Ä¶schedule };

```
if (newSchedule[dateKey]) {
  delete newSchedule[dateKey][type];
  if (Object.keys(newSchedule[dateKey]).length === 0) {
    delete newSchedule[dateKey];
  }
  saveSchedule(newSchedule);
}
```

};

const hasMissingSlots = (date) => {
const dateKey = formatDate(date);
const daySchedule = schedule[dateKey] || {};
return !daySchedule.dropoff || !daySchedule.pickup;
};

const getMissingSlots = (date) => {
const dateKey = formatDate(date);
const daySchedule = schedule[dateKey] || {};
const missing = [];
if (!daySchedule.dropoff) missing.push(‚Äòdropoff‚Äô);
if (!daySchedule.pickup) missing.push(‚Äòpickup‚Äô);
return missing;
};

const handleShare = () => {
const url = window.location.href;
setShareUrl(url);
navigator.clipboard.writeText(url);
alert(‚ÄòShare link copied! Anyone with this link can view and edit the schedule.‚Äô);
};

const previousMonth = () => {
setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1));
};

const nextMonth = () => {
setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1));
};

const days = getDaysInMonth(currentDate);
const monthName = currentDate.toLocaleString(‚Äòdefault‚Äô, { month: ‚Äòlong‚Äô, year: ‚Äònumeric‚Äô });

return (
<div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
<div className="max-w-6xl mx-auto">
{/* Header */}
<div className="bg-white rounded-lg shadow-lg p-6 mb-6">
<div className="flex items-center justify-between mb-4">
<div className="flex items-center gap-3">
<Calendar className="w-8 h-8 text-indigo-600" />
<h1 className="text-3xl font-bold text-gray-800">School Pickup & Dropoff</h1>
</div>
<div className="flex gap-2">
<button
onClick={() => setShowSettingsModal(true)}
className=‚Äúflex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700‚Äù
>
<Bell className="w-4 h-4" />
Notification Settings
</button>
<button
onClick={handleShare}
className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
>
<Share2 className="w-4 h-4" />
Share
</button>
</div>
</div>

```
      <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <div className="flex items-start gap-2">
          <AlertCircle className="w-5 h-5 text-blue-600 mt-0.5" />
          <div className="text-sm text-blue-800">
            <p className="font-semibold">How it works:</p>
            <p>Click on any weekday to assign pickup or dropoff. You'll receive notifications 1 hour before each scheduled time (7 AM for dropoff, 2 PM for pickup).</p>
          </div>
        </div>
      </div>
    </div>

    {/* Calendar */}
    <div className="bg-white rounded-lg shadow-lg p-6">
      {/* Month Navigation */}
      <div className="flex items-center justify-between mb-6">
        <button
          onClick={previousMonth}
          className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
        >
          ‚Üê Previous
        </button>
        <h2 className="text-2xl font-bold text-gray-800">{monthName}</h2>
        <button
          onClick={nextMonth}
          className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
        >
          Next ‚Üí
        </button>
      </div>

      {/* Calendar Grid */}
      <div className="grid grid-cols-7 gap-2">
        {/* Day Headers */}
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
          <div key={day} className="text-center font-bold text-gray-600 py-2">
            {day}
          </div>
        ))}

        {/* Calendar Days */}
        {days.map((date, index) => {
          if (!date) {
            return <div key={`empty-${index}`} className="h-32" />;
          }

          const dateKey = formatDate(date);
          const daySchedule = schedule[dateKey] || {};
          const holiday = isHoliday(date);
          const holidayName = getHolidayName(date);
          const weekday = isWeekday(date);
          const isClickable = weekday && !holiday;
          const missing = hasMissingSlots(date);
          const missingSlots = getMissingSlots(date);

          return (
            <div
              key={dateKey}
              onClick={() => handleDateClick(date)}
              className={`
                h-32 border-2 rounded-lg p-2 transition-all relative
                ${holiday ? 'bg-orange-50 border-orange-300' : ''}
                ${!weekday && !holiday ? 'bg-gray-100 border-gray-200' : ''}
                ${weekday && !holiday ? 'border-gray-300 hover:border-indigo-500 hover:shadow-md cursor-pointer' : ''}
              `}
            >
              <div className="font-semibold text-gray-700 mb-1">
                {date.getDate()}
              </div>

              {/* Missing slots badge */}
              {isClickable && missing && (
                <div className="absolute top-1 right-1 flex gap-1">
                  {missingSlots.map(slot => (
                    <div
                      key={slot}
                      className="w-2 h-2 bg-red-500 rounded-full"
                      title={`Missing ${slot}`}
                    />
                  ))}
                </div>
              )}

              {holiday && (
                <div className="text-xs font-semibold text-orange-600 mb-1">
                  {holidayName}
                </div>
              )}

              {isClickable && (
                <div className="space-y-1">
                  {daySchedule.dropoff && (
                    <div 
                      className="rounded px-2 py-1 text-xs flex items-center justify-between"
                      style={{ 
                        backgroundColor: `${people[daySchedule.dropoff]?.color}20`,
                        borderLeft: `3px solid ${people[daySchedule.dropoff]?.color || '#10B981'}`
                      }}
                    >
                      <div>
                        <div 
                          className="font-semibold"
                          style={{ color: people[daySchedule.dropoff]?.color || '#10B981' }}
                        >
                          ‚Üì {daySchedule.dropoff}
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleRemovePerson(date, 'dropoff');
                        }}
                        className="hover:opacity-70"
                        style={{ color: people[daySchedule.dropoff]?.color || '#10B981' }}
                      >
                        <X className="w-3 h-3" />
                      </button>
                    </div>
                  )}
                  
                  {daySchedule.pickup && (
                    <div 
                      className="rounded px-2 py-1 text-xs flex items-center justify-between"
                      style={{ 
                        backgroundColor: `${people[daySchedule.pickup]?.color}20`,
                        borderLeft: `3px solid ${people[daySchedule.pickup]?.color || '#3B82F6'}`
                      }}
                    >
                      <div>
                        <div 
                          className="font-semibold"
                          style={{ color: people[daySchedule.pickup]?.color || '#3B82F6' }}
                        >
                          ‚Üë {daySchedule.pickup}
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleRemovePerson(date, 'pickup');
                        }}
                        className="hover:opacity-70"
                        style={{ color: people[daySchedule.pickup]?.color || '#3B82F6' }}
                      >
                        <X className="w-3 h-3" />
                      </button>
                    </div>
                  )}

                  {!daySchedule.dropoff && !daySchedule.pickup && (
                    <div className="text-xs text-gray-400 text-center mt-2">
                      Click to add
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>

    {/* Legend */}
    <div className="mt-6 bg-white rounded-lg shadow-lg p-4">
      <h3 className="font-semibold text-gray-700 mb-3">Legend</h3>
      <div className="flex flex-wrap gap-4 text-sm mb-4">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 bg-orange-50 border-2 border-orange-300 rounded"></div>
          <span>School Holiday</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 bg-gray-100 border-2 border-gray-200 rounded"></div>
          <span>Weekend</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 bg-red-500 rounded-full"></div>
          <span>Missing assignment</span>
        </div>
      </div>
      
      {Object.keys(people).length > 0 && (
        <div>
          <h4 className="font-semibold text-gray-700 mb-2">People</h4>
          <div className="flex flex-wrap gap-3">
            {Object.entries(people).map(([name, data]) => (
              <div key={name} className="flex items-center gap-2">
                <div 
                  className="w-4 h-4 rounded-full"
                  style={{ backgroundColor: data.color }}
                ></div>
                <span className="text-sm">{name}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  {/* Add Person Modal */}
  {showAddModal && (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 className="text-xl font-bold mb-4">
          Add Schedule for {selectedDate?.toLocaleDateString()}
        </h3>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-2">Type</label>
            <div className="flex gap-4">
              <label className="flex items-center">
                <input
                  type="radio"
                  value="dropoff"
                  checked={selectedType === 'dropoff'}
                  onChange={(e) => setSelectedType(e.target.value)}
                  className="mr-2"
                />
                Dropoff (8 AM)
              </label>
              <label className="flex items-center">
                <input
                  type="radio"
                  value="pickup"
                  checked={selectedType === 'pickup'}
                  onChange={(e) => setSelectedType(e.target.value)}
                  className="mr-2"
                />
                Pickup (3 PM)
              </label>
            </div>
          </div>

          <div>
            <label className="block text-sm font-semibold mb-2">Person's Name</label>
            <input
              type="text"
              value={personName}
              onChange={(e) => setPersonName(e.target.value)}
              placeholder="Enter name"
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
              onKeyPress={(e) => e.key === 'Enter' && handleAddPerson()}
            />
          </div>

          <div className="flex gap-2 pt-4">
            <button
              onClick={handleAddPerson}
              className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
            >
              Add
            </button>
            <button
              onClick={() => {
                setShowAddModal(false);
                setPersonName('');
              }}
              className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  )}

  {/* Notification Settings Modal */}
  {showSettingsModal && (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 className="text-xl font-bold mb-4">Notification Settings</h3>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-3">How would you like to receive reminders?</label>
            <div className="space-y-2">
              <label className="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="radio"
                  value="push"
                  checked={notificationPreference === 'push'}
                  onChange={(e) => setNotificationPreference(e.target.value)}
                  className="mr-3"
                />
                <div>
                  <div className="font-semibold">Push Notifications Only</div>
                  <div className="text-xs text-gray-600">Get alerts in the app</div>
                </div>
              </label>

              <label className="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="radio"
                  value="sms"
                  checked={notificationPreference === 'sms'}
                  onChange={(e) => setNotificationPreference(e.target.value)}
                  className="mr-3"
                />
                <div>
                  <div className="font-semibold">SMS Only</div>
                  <div className="text-xs text-gray-600">Get text messages</div>
                </div>
              </label>

              <label className="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="radio"
                  value="both"
                  checked={notificationPreference === 'both'}
                  onChange={(e) => setNotificationPreference(e.target.value)}
                  className="mr-3"
                />
                <div>
                  <div className="font-semibold">Both Push & SMS</div>
                  <div className="text-xs text-gray-600">Get all notifications</div>
                </div>
              </label>
            </div>
          </div>

          {(notificationPreference === 'sms' || notificationPreference === 'both') && (
            <div>
              <label className="block text-sm font-semibold mb-2">Phone Number</label>
              <input
                type="tel"
                value={phoneNumber}
                onChange={(e) => setPhoneNumber(e.target.value)}
                placeholder="+61 4XX XXX XXX"
                className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
              />
              <p className="text-xs text-gray-600 mt-1">Include country code (e.g., +61 for Australia)</p>
            </div>
          )}

          <div className="flex gap-2 pt-4">
            <button
              onClick={() => {
                if (notificationPreference === 'push' || notificationPreference === 'both') {
                  if ('Notification' in window) {
                    Notification.requestPermission();
                  }
                }
                saveNotificationPreference(notificationPreference, phoneNumber);
                setShowSettingsModal(false);
                alert('Notification settings saved!');
              }}
              className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
            >
              Save Settings
            </button>
            <button
              onClick={() => setShowSettingsModal(false)}
              className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  )}
</div>
```

);
};

